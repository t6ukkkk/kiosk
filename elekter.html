<!doctype html>
<html lang="et">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elektri hind (Macdronic JSON)</title>
  <style>
    :root { color-scheme: dark; }
    html,body{margin:0;padding:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;background:#0b0b0c;color:#eaeaea;}
    header{position:sticky;top:0;z-index:10;background:#0b0b0c;border-bottom:1px solid #222;padding:10px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#16181a;border:1px solid #2a2d31;font-size:12px}
    .muted{opacity:.75;font-size:12px}
    .big{font-size:22px;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin-top:10px}
    .card{background:#121416;border:1px solid #24282d;border-radius:14px;padding:10px}
    .k{opacity:.7;font-size:12px;margin-bottom:4px}
    .v{font-size:18px;font-weight:700}
    .warn{margin-top:10px;background:#1a1410;border:1px solid #3a2a1f;border-radius:14px;padding:10px}
    .warn a{color:#9ad0ff}
    main{padding:10px 12px}
    table{width:100%;border-collapse:collapse;border:1px solid #24282d;border-radius:14px;overflow:hidden}
    thead th{position:sticky;top:118px;background:#121416;border-bottom:1px solid #24282d;text-align:left;padding:10px;font-size:12px;opacity:.8}
    td{padding:10px;border-bottom:1px solid #1e2227;font-size:14px}
    tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hi{font-weight:800}
    .tag{font-size:12px;opacity:.8}
    .right{text-align:right}
    .ok{color:#7CFF9B}
    .bad{color:#FF7C7C}
    .err{color:#ff6b6b}
    @media (max-width: 900px){ .grid{grid-template-columns:repeat(2,minmax(140px,1fr));} thead th{top:164px} }
  </style>
</head>
<body>

<header>
  <div class="row">
    <span class="pill">Macdronic → tabel</span>
    <span id="title" class="big">Laen…</span>
    <span id="updated" class="muted"></span>
    <span class="pill muted">Auto-refresh: <span id="refresh_s">60</span>s</span>
  </div>

  <div id="alertBox" class="warn" style="display:none;"></div>

  <div class="grid">
    <div class="card"><div class="k">Hetkel</div><div class="v"><span id="current" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva keskmine</div><div class="v"><span id="avg" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva miin</div><div class="v"><span id="min" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva maks</div><div class="v"><span id="max" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
  </div>

  <div class="row" style="margin-top:8px">
    <span class="muted">Allikas:</span>
    <span id="src" class="muted mono"></span>
    <span id="status" class="muted"></span>
  </div>
</header>

<main>
  <div id="error" class="err"></div>

  <table id="tbl" style="display:none;">
    <thead>
      <tr>
        <th style="width:38%">Aeg</th>
        <th class="right" style="width:20%">Hind</th>
        <th style="width:42%">Märge</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</main>

<script>
  // ✅ PUT YOUR JSON URL HERE:
  const SRC = "https://api.allorigins.win/raw?url=" +
  encodeURIComponent("https://home.macdronic.com/et/elekter/live/1251892/64548ee8659d7c63e31a86753852de0c");
  // refresh interval
  const REFRESH_S = 60;

  document.getElementById("refresh_s").textContent = String(REFRESH_S);
  document.getElementById("src").textContent = SRC;

  const fmt = (n) => (typeof n === "number" ? (Math.round(n * 1000) / 1000).toFixed(3).replace(".", ",") : "—");

  function setText(id, val){ document.getElementById(id).textContent = val; }

  // timeline can be: array of objects, OR array of arrays, OR object with numeric keys.
  function flattenTimeline(tl){
    if (!tl) return [];
    if (Array.isArray(tl)) {
      // already an array; flatten 1 level if it contains arrays
      return tl.flatMap(x => Array.isArray(x) ? x : [x]).filter(Boolean);
    }
    if (typeof tl === "object") {
      // object with keys like 0..99 etc
      const vals = Object.values(tl).flatMap(x => Array.isArray(x) ? x : [x]);
      return vals.filter(Boolean);
    }
    return [];
  }

  // Detect likely time & price keys in a row object
  function detectKeys(row){
    const keys = Object.keys(row || {});
    const timeKey = keys.find(k => /time|label|from|start|date|kell|hour/i.test(k)) || keys[0];
    const priceKey = keys.find(k => /price|hind|value|eur|cent|senti/i.test(k)) || keys.find(k => typeof row[k] === "number");
    return { timeKey, priceKey };
  }

  function renderTable(rows, minV, maxV){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if (!rows.length){ return; }

    // ensure objects
    const objRows = rows.map(r => (typeof r === "object" ? r : { value: r }));
    const { timeKey, priceKey } = detectKeys(objRows[0]);

    for (const r of objRows){
      const t = r[timeKey];
      const p = r[priceKey];

      const isMin = (typeof p === "number" && p === minV);
      const isMax = (typeof p === "number" && p === maxV);

      const note = isMin ? "min" : isMax ? "max" : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono ${note ? "hi" : ""}">${t ?? ""}</td>
        <td class="mono right ${note ? "hi" : ""}">${typeof p === "number" ? fmt(p) : (p ?? "")}</td>
        <td class="tag">${note}</td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById("tbl").style.display = "";
  }

  async function load(){
    const status = document.getElementById("status");
    const error = document.getElementById("error");
    error.textContent = "";
    status.textContent = "⟳ Laen…";

    try{
      const res = await fetch(SRC, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const j = await res.json();

      // header fields you pasted
      setText("title", j.chartTitle || ("Elektri hind " + (j.day || "")));
      setText("updated", j.DateUpdated ? ("• uuendatud " + j.DateUpdated) : "");
      setText("current", fmt(j.currentPriceValue ?? j.currentPrice));
      setText("avg", fmt(j.avg));
      setText("min", fmt(j.min));
      setText("max", fmt(j.max));

      // alert box (HTML allowed)
      const alertBox = document.getElementById("alertBox");
      const alertHtml = (j.alert_info && j.alert_info.text) ? j.alert_info.text : (j.alert || "");
      if (alertHtml){
        alertBox.style.display = "";
        alertBox.innerHTML = alertHtml;
      } else {
        alertBox.style.display = "none";
        alertBox.innerHTML = "";
      }

      // timeline → table
      const rows = flattenTimeline(j.timeline);

      // derive min/max from timeline if possible (more accurate for “min/max rows” highlight)
      let minV = Infinity, maxV = -Infinity;
      for(const r of rows){
        if(typeof r === "object"){
          for(const v of Object.values(r)){
            if(typeof v === "number"){
              if(v < minV) minV = v;
              if(v > maxV) maxV = v;
              break;
            }
          }
        }
      }
      if(!isFinite(minV)) minV = null;
      if(!isFinite(maxV)) maxV = null;

      renderTable(rows, minV, maxV);

      status.textContent = "✓ " + new Date().toLocaleTimeString();
    } catch(e){
      error.textContent = "Viga: " + (e?.message || e);
      status.textContent = "✕";
    }
  }

  load();
  setInterval(load, REFRESH_S * 1000);
</script>

</body>
</html>
