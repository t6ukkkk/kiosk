<!doctype html>
<html lang="et">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Elektri hind (Macdronic JSON)</title>
  <style>
    :root { color-scheme: dark; }
    html,body{
      margin:0;padding:0;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;
      background:#0b0b0c;color:#eaeaea;
    }
    header{
      position:sticky;top:0;z-index:10;
      background:#0b0b0c;border-bottom:1px solid #222;
      padding:10px 12px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#16181a;border:1px solid #2a2d31;font-size:12px}
    .muted{opacity:.75;font-size:12px}
    .big{font-size:22px;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin-top:10px}
    .card{background:#121416;border:1px solid #24282d;border-radius:14px;padding:10px}
    .k{opacity:.7;font-size:12px;margin-bottom:4px}
    .v{font-size:18px;font-weight:700}
    main{padding:10px 12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .tag{font-size:12px;opacity:.8}
    .err{color:#ff6b6b}
    @media (max-width: 900px){
      .grid{grid-template-columns:repeat(2,minmax(140px,1fr));}
    }
  </style>
</head>
<body>

<header>
  <div class="row">
    <span class="pill">Macdronic → tabel</span>
    <span id="title" class="big">Laen…</span>
    <span id="updated" class="muted"></span>
    <span class="pill muted">Auto-refresh: <span id="refresh_s">60</span>s</span>
  </div>

  <div class="grid">
    <div class="card"><div class="k">Hetkel</div><div class="v"><span id="current" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva keskmine</div><div class="v"><span id="avg" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva miin</div><div class="v"><span id="min" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
    <div class="card"><div class="k">Päeva maks</div><div class="v"><span id="max" class="mono">—</span> <span class="tag">senti/kWh</span></div></div>
  </div>
</header>

<main>
  <div id="error" class="err"></div>
  <div style="height:65vh;">
    <canvas id="priceChart"></canvas>
  </div>
</main>

<script>
const SRC = "https://cold-shape-2620.mihkel-pranstibel.workers.dev/";
let chart;
let currentBarIndex = -1; // used by glow plugin

function fmt2(n){
  return (Number.isFinite(n) ? n.toFixed(2) : "—");
}

function sameLocalHour(tsSeconds, nowDate){
  const d = new Date(tsSeconds * 1000);
  return (
    d.getFullYear() === nowDate.getFullYear() &&
    d.getMonth() === nowDate.getMonth() &&
    d.getDate() === nowDate.getDate() &&
    d.getHours() === nowDate.getHours()
  );
}

// Group 15-min points into hourly averages
function toHourlyAverages(timeline){
  const map = new Map(); // key -> {sum, count, ts}
  for (const t of timeline){
    const ts = Number(t.startTimestamp ?? t.timestamp);
    const price = Number(t.price ?? t.value);
    if (!Number.isFinite(ts) || !Number.isFinite(price)) continue;

    const d = new Date(ts * 1000);
    const key =
      d.getFullYear() + "-" +
      String(d.getMonth()+1).padStart(2,"0") + "-" +
      String(d.getDate()).padStart(2,"0") + " " +
      String(d.getHours()).padStart(2,"0");

    const cur = map.get(key) ?? { sum: 0, count: 0, ts: ts };
    cur.sum += price;
    cur.count += 1;
    if (ts < cur.ts) cur.ts = ts; // earliest timestamp for ordering
    map.set(key, cur);
  }

  const rows = [...map.entries()]
    .map(([key, v]) => ({ ts: v.ts, avg: v.sum / v.count }))
    .sort((a,b) => a.ts - b.ts);

  const labels = rows.map(r => {
    const d = new Date(r.ts * 1000);
    return String(d.getHours()).padStart(2,"0") + ":00"; // 24h mode
  });

  const data = rows.map(r => r.avg);
  const tsList = rows.map(r => r.ts);

  return { labels, data, tsList };
}

function colorForValue(v){
  if (!Number.isFinite(v)) return "rgba(120,120,120,0.6)";
  if (v > 18) return "rgba(255, 90, 90, 0.85)";     // red
  if (v < 11) return "rgba(120, 255, 160, 0.85)";   // green
  return "rgba(255, 180, 80, 0.85)";                // orange
}

// Glow plugin for the selected bar (current hour)
const glowCurrentBarPlugin = {
  id: 'glowCurrentBar',
  beforeDatasetsDraw(chart, args, pluginOptions) {
    const idx = currentBarIndex;
    if (idx < 0) return;

    const meta = chart.getDatasetMeta(0);
    const el = meta?.data?.[idx];
    if (!el) return;

    const ctx = chart.ctx;

    // Draw a glowing overlay by re-drawing the same bar with shadow
    ctx.save();
    ctx.shadowColor = 'rgba(255,255,255,0.85)';
    ctx.shadowBlur = 18;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;

    // A slightly brighter overlay
    ctx.globalAlpha = 0.9;
    const props = el.getProps(['x','y','base','width'], true);
    const left = props.x - props.width / 2;
    const top = Math.min(props.y, props.base);
    const height = Math.abs(props.base - props.y);

    // draw overlay rectangle
    ctx.fillStyle = 'rgba(255,255,255,0.18)';
    ctx.fillRect(left - 1, top - 2, props.width + 2, height + 4);

    ctx.restore();
  }
};

async function loadData() {
  const errorEl = document.getElementById("error");
  errorEl.textContent = "";

  const r = await fetch(SRC, { cache: "no-store" });
  if (!r.ok) throw new Error("HTTP " + r.status);

  const j = await r.json();

  // summary
  document.getElementById("current").textContent = fmt2(j.currentPrice);
  document.getElementById("avg").textContent = fmt2(j.avg);
  document.getElementById("min").textContent = fmt2(j.min);
  document.getElementById("max").textContent = fmt2(j.max);

  if (j.chartTitle) document.getElementById("title").textContent = j.chartTitle;
  if (j.DateUpdated) document.getElementById("updated").textContent = "• uuendatud " + j.DateUpdated;

  const timeline = Array.isArray(j.timeline) ? j.timeline : [];
  const { labels, data, tsList } = toHourlyAverages(timeline);

  if (!labels.length || !data.length) {
    throw new Error("Graafiku andmeid ei leitud (timeline tühi või väljad ei klapi).");
  }

  // set current hour index for glow
  const now = new Date();
  currentBarIndex = tsList.findIndex(ts => sameLocalHour(ts, now));

  const bgColors = data.map(v => colorForValue(v));

  drawChart(labels, data, bgColors);
}

function drawChart(labels, data, bgColors) {
  const ctx = document.getElementById("priceChart");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: bgColors,
        borderWidth: (ctx) => (ctx.dataIndex === currentBarIndex ? 2 : 0),
        borderColor: (ctx) => (ctx.dataIndex === currentBarIndex ? "rgba(255,255,255,0.95)" : "rgba(0,0,0,0)")
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          ticks: {
            autoSkip: true,
            maxTicksLimit: 24,
            minRotation: 90,
            maxRotation: 90
          }
        },
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 5   // horizontal lines every 5 cents
          },
          grid: {
            display: true
          },
          title: {
            display: true,
            text: "senti/kWh"
          }
        }
      }
    },
    plugins: [glowCurrentBarPlugin]
  });
}

// initial + refresh
(async ()=>{
  try { await loadData(); }
  catch(e){ document.getElementById("error").textContent = "Viga: " + (e?.message ?? e); }
})();
setInterval(async ()=>{
  try { await loadData(); }
  catch(e){ document.getElementById("error").textContent = "Viga: " + (e?.message ?? e); }
}, 5 * 60 * 1000);
</script>

</body>
</html>
